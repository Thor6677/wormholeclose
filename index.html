<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>W-Space Wormhole Closer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; max-width: 600px; }
    h1, h2 { text-align: center; }
    .step { display: none; }
    .step.active { display: block; }
    .wizard-nav { margin-top: 1.5rem; display: flex; justify-content: space-between; }
    button { padding: .5rem 1rem; }
    #suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; margin-top: .5rem; }
    .suggestion { padding: .5rem; cursor: pointer; }
    .suggestion:hover { background: #eee; }
    pre { background: #f9f9f9; padding: 1rem; white-space: pre-wrap; }
    @media (max-width: 480px) {
      button { flex: 1; margin: .25rem 0; }
      .wizard-nav { flex-direction: column-reverse; }
    }
  </style>
</head>
<body>

  <h1>W-Space Wormhole Closer</h1>
  
  <!-- Step 1: Select Wormhole -->
  <div id="step-1" class="step active">
    <h2>Step 1: Choose Wormhole</h2>
    <input type="text" id="wh-search" placeholder="Type wormhole code…" autocomplete="off" />
    <div id="suggestions"></div>
    <div id="wh-details"></div>
  </div>
  
  <!-- Step 2: State & Goal -->
  <div id="step-2" class="step">
    <h2>Step 2: State & Goal</h2>
    <label>
      Current Status:
      <select id="status-select">
        <option value="stable">Stable (100→50%)</option>
        <option value="unstable">Unstable (50→10%)</option>
        <option value="critical">Critical (10→0%)</option>
      </select>
    </label>
    <br><br>
    <label>
      Goal:
      <select id="goal-select">
        <option value="close">Close (0%)</option>
        <option value="crit">Crit (10%)</option>
      </select>
    </label>
  </div>

  <!-- Step 3: Enter Ship Mass -->
  <div id="step-3" class="step">
    <h2>Step 3: Enter Ship Mass</h2>
    <label>
      Cold Mass (kg):
      <input type="number" id="cold-mass" placeholder="e.g. 1650000" />
    </label>
    <br><br>
    <label>
      Hot Mass (kg):
      <input type="number" id="hot-mass" placeholder="e.g. 2475000" />
    </label>
  </div>

  <!-- Step 4: Initial Jump Plan -->
  <div id="step-4" class="step">
    <h2>Step 4: Initial Jump</h2>
    <p id="initial-summary"></p>
    <pre id="initial-steps"></pre>
  </div>

  <!-- Step 5: Return Jump (Interactive) -->
  <div id="step-5" class="step">
    <h2>Step 5: Return Jump</h2>
    <p>Select the hole’s observed state after your initial jump:</p>
    <label>
      Hole State:
      <select id="return-state">
        <option value="stable">Stable (50–100%)</option>
        <option value="unstable">Unstable (10–50%)</option>
        <option value="critical">Critical (0–10%)</option>
      </select>
    </label>
    <div id="return-suggestion" style="margin-top:1rem;"></div>
  </div>

  <!-- Wizard Navigation -->
  <div class="wizard-nav">
    <button id="btn-reset">Reset</button>
    <div>
      <button id="btn-back" disabled>Back</button>
      <button id="btn-next">Next</button>
    </div>
  </div>

  <script type="module">
    import { wormholes } from './data/wormholes.js';

    // Wizard state
    let currentStep = 1;
    let currentWH = null;
    let startMass = 0, goalMass = 0;
    let shipCount = 0, remAfterInit = 0;
    let retClose = { cold:0, hot:0 }, retCrit = { cold:0, hot:0 };

    // UI refs
    const steps       = {1:'#step-1',2:'#step-2',3:'#step-3',4:'#step-4',5:'#step-5'};
    const btnNext     = document.getElementById('btn-next');
    const btnBack     = document.getElementById('btn-back');
    const btnReset    = document.getElementById('btn-reset');
    const whSearch    = document.getElementById('wh-search');
    const suggestions = document.getElementById('suggestions');
    const whDetails   = document.getElementById('wh-details');
    const statusSel   = document.getElementById('status-select');
    const goalSel     = document.getElementById('goal-select');
    const coldInput   = document.getElementById('cold-mass');
    const hotInput    = document.getElementById('hot-mass');
    const initSummary = document.getElementById('initial-summary');
    const initSteps   = document.getElementById('initial-steps');
    const returnState = document.getElementById('return-state');
    const returnDiv   = document.getElementById('return-suggestion');

    function showStep(n) {
      Object.values(steps).forEach(sel => document.querySelector(sel).classList.remove('active'));
      document.querySelector(steps[n]).classList.add('active');
      btnBack.disabled = (n===1);
      btnNext.textContent = n===5 ? 'Finish' : 'Next';
    }

    // Reset
    btnReset.onclick = () => {
      currentStep=1; currentWH=null; startMass=goalMass=0;
      shipCount=remAfterInit=0; retClose={}; retCrit={};
      whSearch.value=''; suggestions.innerHTML=''; whDetails.innerHTML='';
      coldInput.value=''; hotInput.value='';
      initSummary.textContent=''; initSteps.textContent='';
      returnDiv.innerHTML='';
      showStep(1);
    };

    btnBack.onclick = () => {
      if(currentStep>1){ currentStep--; showStep(currentStep); }
    };

    btnNext.onclick = () => {
      // Step 1
      if(currentStep===1 && !currentWH){
        alert('Please select a wormhole.'); return;
      }
      // Step 2
      if(currentStep===2){
        const pct={stable:1,unstable:0.5,critical:0.1}[statusSel.value];
        startMass = Math.round(currentWH.totalMass * pct);
        goalMass  = (goalSel.value==='close')
          ? 0
          : Math.round(currentWH.totalMass * 0.1);
      }
      // Step 3
      if(currentStep===3){
        if(!coldInput.value||!hotInput.value){
          alert('Enter both cold and hot mass.'); return;
        }
        buildInitialPlan();
      }
      // Step 4 → prepare Step 5
      if(currentStep===4){
        prepareReturnData();
        updateReturnSuggestion();
      }
      // advance/finish
      if(currentStep<5){
        currentStep++; showStep(currentStep);
      } else {
        alert('Done – follow the steps in-game!');
      }
    };

    // --- Step 1: search & select ---
    whSearch.oninput = () => {
      const q=whSearch.value.trim().toUpperCase();
      suggestions.innerHTML=''; whDetails.innerHTML=''; currentWH=null;
      if(!q) return;
      wormholes
        .filter(w=>w.type.startsWith(q))
        .slice(0,8)
        .forEach(w=>{
          const d=document.createElement('div');
          d.className='suggestion';
          d.textContent=w.type;
          d.onclick=()=>selectWH(w);
          suggestions.appendChild(d);
        });
    };

    function selectWH(w){
      currentWH={...w};
      whSearch.value=w.type;
      suggestions.innerHTML='';
      let html=`<strong>${w.type}</strong><ul>
        <li>From: ${w.from||'—'}</li>
        <li>To: ${w.to}</li>
        <li>Total Mass: ${w.totalMass.toLocaleString()}</li>
        <li>Max Jump Mass: ${w.maxIndividualMass.toLocaleString()}</li>
        <li>Class: ${w.classification}</li>
        <li>Max Stable Time: ${w.maxStableTime} h</li>`;
      if(w.massRegeneration){
        html+=`<li>Regen: ${w.massRegeneration.toLocaleString()}/s</li>`;
      }
      html+=`</ul>`;
      whDetails.innerHTML=html;
    }

    // --- Step 4: initial plan ---
    function buildInitialPlan(){
      const cold=parseInt(coldInput.value,10),
            hot =parseInt(hotInput.value,10),
            diff=Math.max(0,startMass-goalMass);
      shipCount = Math.ceil(diff/(hot+hot));
      remAfterInit = startMass - (cold + hot*(shipCount-1));
      initSummary.textContent=
        `Use ${shipCount} ships: 1 cold & ${shipCount-1} hot test jump.`;
      initSteps.textContent=[
        `Start mass: ${startMass.toLocaleString()} kg`,
        `Jump mass: ${(cold + (shipCount-1)*hot).toLocaleString()} kg`,
        `Est. remaining: ${remAfterInit.toLocaleString()} kg`
      ].join('\n');
    }

    // --- Prepare return data ---
    function prepareReturnData(){
      const total=currentWH.totalMass,
            thresh10=Math.round(total*0.1),
            needClose=remAfterInit - 0,
            needCrit =remAfterInit - thresh10;
      retClose = computeReturn(needClose);
      retCrit  = computeReturn(needCrit);
      returnState.onchange = updateReturnSuggestion;
    }

    function computeReturn(diff){
      const cold=parseInt(coldInput.value,10),
            hot =parseInt(hotInput.value,10);
      for(let h=0; h<=shipCount; h++){
        const c=shipCount-h;
        if(h*hot + c*cold >= diff){
          return { cold:c, hot:h };
        }
      }
      return { cold:0, hot:shipCount };
    }

    function computePassable(coldCount, hotCount){
      let rem = remAfterInit,
          hotMass=parseInt(hotInput.value,10),
          coldMass=parseInt(coldInput.value,10);
      const hotPass = Math.min(hotCount, Math.floor(rem/hotMass));
      rem -= hotPass*hotMass;
      const coldPass = Math.min(coldCount, Math.floor(rem/coldMass));
      const stranded = (coldCount + hotCount) - (hotPass + coldPass);
      return { hotPass, coldPass, stranded };
    }

    function updateReturnSuggestion(){
      const st=returnState.value.charAt(0).toUpperCase()+returnState.value.slice(1);
      const cClose = computePassable(retClose.cold, retClose.hot),
            cCrit  = computePassable(retCrit.cold,  retCrit.hot);
      returnDiv.innerHTML=`
        <p><strong>If ${st}:</strong></p>
        <p><em>To Close:</em> ${retClose.cold} cold & ${retClose.hot} hot`+
        (cClose.stranded
          ? ` → ${cClose.stranded} ship${cClose.stranded>1?'s':''} may not pass`
          : ` (all will pass)`)
        +`</p>
        <p><em>To Crit:</em> ${retCrit.cold} cold & ${retCrit.hot} hot`+
        (cCrit.stranded
          ? ` → ${cCrit.stranded} may not pass`
          : ` (all will pass)`)
        +`</p>
      `;
    }

    // Init
    showStep(1);
  </script>

</body>
</html>
