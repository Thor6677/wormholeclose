<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wormhole Search</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; margin-top: 5px; }
    .suggestion { padding: 4px; cursor: pointer; }
    .suggestion:hover { background-color: #eee; }
    .hidden { display: none; }
    pre { background: #f9f9f9; padding: 10px; }
  </style>
</head>
<body>
  <h1>Wormhole Search</h1>
  <input type="text" id="search" placeholder="Type wormhole code..." autocomplete="off" />
  <div id="suggestions" class="hidden"></div>
  <div id="details"></div>

  <div id="setup" class="hidden">
    <label>
      Current Status:
      <select id="status-select">
        <option value="stable">Stable</option>
        <option value="unstable">Unstable</option>
        <option value="critical">Critical</option>
      </select>
    </label>
    <label>
      Goal:
      <select id="goal-select">
        <option value="close">Close</option>
        <option value="crit">Crit</option>
      </select>
    </label>
    <button id="start-tracking">Start</button>
  </div>

  <div id="mass-tracker" class="hidden">
    <h2>Mass Tracker</h2>
    <div>Remaining Mass: <span id="remaining-mass"></span></div>
    <div>State: <span id="wh-state"></span></div>
    <div>Mass to Goal: <span id="goal-mass"></span></div>
    <label>
      Ship Hull:
      <select id="ship-select"></select>
    </label>
    <label>
      Cold Mass (kg): <input type="number" id="cold-mass" />
    </label>
    <label>
      Hot Mass (kg): <input type="number" id="hot-mass" />
    </label>
    <label>
      Use Hot Mass <input type="checkbox" id="use-hot" />
    </label>
    <button id="add-jump">Add Jump</button>
    <button id="reset-mass">Reset</button>
    <button id="plan-jumps">Plan Jumps</button>
    <div id="jump-plan" class="hidden">
      <h3>Jump Plan</h3>
      <div id="jump-step"></div>
      <button id="next-step">Next Step</button>
    </div>
  </div>

  <script type="module">
    import { wormholes } from './data/wormholes.js';

    const input = document.getElementById('search');
    const suggestions = document.getElementById('suggestions');
    const details = document.getElementById('details');
    const setupDiv = document.getElementById('setup');
    const statusSelect = document.getElementById('status-select');
    const goalSelect = document.getElementById('goal-select');
    const startBtn = document.getElementById('start-tracking');
    const tracker = document.getElementById('mass-tracker');
    const remainingSpan = document.getElementById('remaining-mass');
    const stateSpan = document.getElementById('wh-state');
    const goalSpan = document.getElementById('goal-mass');
    const shipSelect = document.getElementById('ship-select');
    const coldInput = document.getElementById('cold-mass');
    const hotInput = document.getElementById('hot-mass');
    const useHot = document.getElementById('use-hot');
    const addJump = document.getElementById('add-jump');
    const resetMass = document.getElementById('reset-mass');
    const planJumps = document.getElementById('plan-jumps');
    const jumpPlanDiv = document.getElementById('jump-plan');
    const jumpStepDiv = document.getElementById('jump-step');
    const nextStepBtn = document.getElementById('next-step');

    const defaultShips = [
      { name: 'Capsule', cold: 10000, hot: 10000 },
      { name: 'Frigate', cold: 1100000, hot: 1650000 },
      { name: 'Destroyer', cold: 1500000, hot: 2250000 },
      { name: 'Cruiser', cold: 12000000, hot: 18000000 },
      { name: 'Battlecruiser', cold: 13000000, hot: 19500000 },
      { name: 'Battleship', cold: 63000000, hot: 94500000 },
      { name: 'Custom', cold: 0, hot: 0 }
    ];

    defaultShips.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = s.name;
      shipSelect.appendChild(opt);
    });

    shipSelect.addEventListener('change', () => {
      const ship = defaultShips.find(s => s.name === shipSelect.value);
      if (ship) {
        coldInput.value = ship.cold;
        hotInput.value = ship.hot;
      }
    });

    let currentWH = null;
    let currentMatches = [];
    let planSteps = [];
    let planIndex = 0;
    let goalMass = 0;
    let startMass = 0;

    function updateStateDisplay() {
      if (!currentWH) return;
      remainingSpan.textContent = currentWH.remainingMass.toLocaleString();
      const total = currentWH.totalMass;
      let state = 'Stable';
      if (currentWH.remainingMass <= total * 0.1) {
        state = 'Critical';
      } else if (currentWH.remainingMass <= total * 0.5) {
        state = 'Unstable';
      }
      stateSpan.textContent = state;
      goalSpan.textContent = Math.max(0, currentWH.remainingMass - goalMass).toLocaleString();
    }

    function calculatePlan() {
      if (!currentWH) return [];
      const mass = parseInt(useHot.checked ? hotInput.value : coldInput.value, 10) || 0;
      if (mass <= 0) return [];
      if (mass > currentWH.maxIndividualMass) {
        alert('Selected ship exceeds max individual mass for this wormhole!');
        return [];
      }
      let remaining = currentWH.remainingMass;
      const steps = [];
      let out = true;
      while (remaining > goalMass) {
        remaining -= mass;
        const final = remaining <= goalMass;
        steps.push({
          label: (out ? 'Jump out' : 'Jump back') + (final ? ' (final)' : ''),
          remaining: final ? goalMass : remaining
        });
        out = !out;
      }
      return steps;
    }

    addJump.addEventListener('click', () => {
      if (!currentWH) return;
      const mass = parseInt(useHot.checked ? hotInput.value : coldInput.value, 10) || 0;
      currentWH.remainingMass = Math.max(goalMass, currentWH.remainingMass - mass);
      updateStateDisplay();
    });

    planJumps.addEventListener('click', () => {
      planSteps = calculatePlan();
      planIndex = 0;
      if (planSteps.length === 0) {
        jumpPlanDiv.classList.add('hidden');
        return;
      }
      nextStepBtn.disabled = false;
      jumpPlanDiv.classList.remove('hidden');
      jumpStepDiv.textContent = `${planSteps[0].label} - Remaining mass: ${planSteps[0].remaining.toLocaleString()}`;
    });

    nextStepBtn.addEventListener('click', () => {
      if (planIndex >= planSteps.length) return;
      const step = planSteps[planIndex];
      currentWH.remainingMass = step.remaining;
      updateStateDisplay();
      planIndex++;
      if (planIndex < planSteps.length) {
        const next = planSteps[planIndex];
        jumpStepDiv.textContent = `${next.label} - Remaining mass: ${next.remaining.toLocaleString()}`;
      } else {
        jumpStepDiv.textContent = 'Plan complete';
        nextStepBtn.disabled = true;
      }
    });

    resetMass.addEventListener('click', () => {
      if (!currentWH) return;
      currentWH.remainingMass = startMass;
      updateStateDisplay();
      jumpPlanDiv.classList.add('hidden');
      planSteps = [];
    });

    function hideSuggestions() {
      suggestions.textContent = '';
      suggestions.classList.add('hidden');
    }

    function clearAll() {
      hideSuggestions();
      tracker.classList.add('hidden');
      setupDiv.classList.add('hidden');
      currentWH = null;
      jumpPlanDiv.classList.add('hidden');
      planSteps = [];
    }

    function showDetails(wh) {
      details.innerHTML = `<strong>${wh.type}</strong> (${wh.from || '?' } &rarr; ${wh.to || '?'})<ul>` +
        `<li>Total Mass: ${wh.totalMass.toLocaleString()}</li>` +
        `<li>Max Individual Mass: ${wh.maxIndividualMass.toLocaleString()}</li>` +
        `</ul>`;
      setupDiv.classList.remove('hidden');
      tracker.classList.add('hidden');
      currentWH = { ...wh };
      shipSelect.value = defaultShips[0].name;
      coldInput.value = defaultShips[0].cold;
      hotInput.value = defaultShips[0].hot;
      useHot.checked = false;
      jumpPlanDiv.classList.add('hidden');
      planSteps = [];
    }

    startBtn.addEventListener('click', () => {
      if (!currentWH) return;
      const perc = {
        stable: 0.75,
        unstable: 0.3,
        critical: 0.05
      }[statusSelect.value] || 0.75;
      const total = currentWH.totalMass;
      currentWH.remainingMass = Math.round(total * perc);
      startMass = currentWH.remainingMass;
      goalMass = goalSelect.value === 'close' ? 0 : Math.round(total * 0.1);
      tracker.classList.remove('hidden');
      jumpPlanDiv.classList.add('hidden');
      planSteps = [];
      updateStateDisplay();
    });

    input.addEventListener('input', () => {
      const query = input.value.trim().toUpperCase();
      details.textContent = '';
      if (!query) {
        clearAll();
        return;
      }
      const matches = wormholes.filter(w => w.type.startsWith(query));
      currentMatches = matches;
      if (matches.length === 0) {
        clearAll();
        return;
      }
      suggestions.innerHTML = '';
      matches.forEach(m => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = m.type;
        div.addEventListener('click', () => {
          input.value = m.type;
          hideSuggestions();
          showDetails(m);
        });
        suggestions.appendChild(div);
      });
      if (matches.length === 1 && matches[0].type === query) {
        showDetails(matches[0]);
        hideSuggestions();
      } else {
        suggestions.classList.remove('hidden');
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target !== input && !suggestions.contains(e.target)) {
        hideSuggestions();
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (currentMatches.length > 0) {
          input.value = currentMatches[0].type;
          showDetails(currentMatches[0]);
          hideSuggestions();
        }
      }
    });

    input.addEventListener('blur', () => {
      const query = input.value.trim().toUpperCase();
      const match = wormholes.find(w => w.type === query);
      if (match) {
        showDetails(match);
      }
      hideSuggestions();
    });
  </script>
</body>
</html>
