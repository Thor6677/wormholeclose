<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>W-Space Wormhole Closer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; max-width: 600px; }
    h1, h2 { text-align: center; }
    .step { display: none; }
    .step.active { display: block; }
    .wizard-nav { margin-top: 1.5rem; display: flex; justify-content: space-between; }
    button { padding: .5rem 1rem; }
    #suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; margin-top: .5rem; }
    .suggestion { padding: .5rem; cursor: pointer; }
    .suggestion:hover { background: #eee; }
    pre { background: #f9f9f9; padding: 1rem; white-space: pre-wrap; }
    @media (max-width: 480px) {
      button { flex: 1; margin: .25rem 0; }
      .wizard-nav { flex-direction: column-reverse; }
    }
  </style>
</head>
<body>

  <h1>W-Space Wormhole Closer</h1>
  
  <!-- Step 1: Select Wormhole -->
  <div id="step-1" class="step active">
    <h2>Step 1: Choose Wormhole</h2>
    <input type="text" id="wh-search" placeholder="Type wormhole code…" autocomplete="off"/>
    <div id="suggestions"></div>
    <div id="wh-details"></div>
  </div>
  
  <!-- Step 2: State & Goal -->
  <div id="step-2" class="step">
    <h2>Step 2: State &amp; Goal</h2>
    <label>
      Current Status:
      <select id="status-select">
        <option value="stable">Stable (100→50%)</option>
        <option value="unstable">Unstable (50→10%)</option>
        <option value="critical">Critical (10→0%)</option>
      </select>
    </label>
    <br><br>
    <label>
      Goal:
      <select id="goal-select">
        <option value="close">Close (0%)</option>
        <option value="crit">Crit (10%)</option>
      </select>
    </label>
  </div>

  <!-- Step 3: Enter Ship Mass -->
  <div id="step-3" class="step">
    <h2>Step 3: Enter Ship Mass</h2>
    <label>
      Cold Mass (kg):
      <input type="number" id="cold-mass" placeholder="e.g. 1650000"/>
    </label>
    <br><br>
    <label>
      Hot Mass (kg):
      <input type="number" id="hot-mass" placeholder="e.g. 2475000"/>
    </label>
  </div>

  <!-- Step 4: Jump Plan -->
  <div id="step-4" class="step">
    <h2>Step 4: Jump Plan</h2>
    <p><strong>Plan:</strong> <span id="plan-summary"></span></p>
    <pre id="plan-steps"></pre>
  </div>

  <!-- Wizard Navigation -->
  <div class="wizard-nav">
    <button id="btn-reset">Reset</button>
    <div>
      <button id="btn-back" disabled>Back</button>
      <button id="btn-next">Next</button>
    </div>
  </div>

  <script type="module">
    import { wormholes } from './data/wormholes.js';

    // Wizard state
    let currentStep = 1;
    let currentWH = null;
    let startMass = 0, goalMass = 0;

    // UI refs
    const steps      = {1: '#step-1', 2: '#step-2', 3: '#step-3', 4: '#step-4'};
    const btnNext    = document.getElementById('btn-next');
    const btnBack    = document.getElementById('btn-back');
    const btnReset   = document.getElementById('btn-reset');
    const whSearch   = document.getElementById('wh-search');
    const suggestions= document.getElementById('suggestions');
    const whDetails  = document.getElementById('wh-details');
    const statusSel  = document.getElementById('status-select');
    const goalSel    = document.getElementById('goal-select');
    const coldInput  = document.getElementById('cold-mass');
    const hotInput   = document.getElementById('hot-mass');
    const planSummary= document.getElementById('plan-summary');
    const planSteps  = document.getElementById('plan-steps');

    function showStep(n) {
      Object.values(steps).forEach(sel => document.querySelector(sel).classList.remove('active'));
      document.querySelector(steps[n]).classList.add('active');
      btnBack.disabled = (n === 1);
      btnNext.textContent = n === 4 ? 'Finish' : 'Next';
    }

    // Reset wizard
    btnReset.onclick = () => {
      currentStep = 1; currentWH = null; startMass = goalMass = 0;
      whSearch.value = ''; suggestions.innerHTML = ''; whDetails.innerHTML = '';
      coldInput.value = ''; hotInput.value = '';
      planSummary.textContent = ''; planSteps.textContent = '';
      showStep(1);
    };

    // Back button
    btnBack.onclick = () => {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
      }
    };

    // Next button
    btnNext.onclick = () => {
      // Step 1 validation
      if (currentStep === 1 && !currentWH) {
        alert('Please select a wormhole.');
        return;
      }
      // Step 2: compute startMass & goalMass
      if (currentStep === 2) {
        const percMap = { stable: 1, unstable: 0.5, critical: 0.1 };
        startMass = Math.round(currentWH.totalMass * percMap[statusSel.value]);
        goalMass  = goalSel.value === 'close'
          ? 0
          : Math.round(currentWH.totalMass * 0.1);
      }
      // Step 3 validation
      if (currentStep === 3) {
        if (!coldInput.value || !hotInput.value) {
          alert('Enter both cold and hot mass.');
          return;
        }
        buildPlan();
      }
      // Advance or finish
      if (currentStep < 4) {
        currentStep++;
        showStep(currentStep);
      } else {
        alert('Done! Reset to start over.');
      }
    };

    // --- Step 1: search & select ---
    whSearch.oninput = () => {
      const q = whSearch.value.trim().toUpperCase();
      suggestions.innerHTML = '';
      whDetails.innerHTML = '';
      currentWH = null;
      if (!q) return;
      wormholes
        .filter(w => w.type.startsWith(q))
        .slice(0,8)
        .forEach(w => {
          const div = document.createElement('div');
          div.className = 'suggestion';
          div.textContent = w.type;
          div.onclick = () => selectWH(w);
          suggestions.appendChild(div);
        });
    };

    function selectWH(w) {
      currentWH = { ...w };
      whSearch.value = w.type;
      suggestions.innerHTML = '';
      let html = `<strong>${w.type}</strong><ul>
        <li>From: ${w.from||'–'}</li>
        <li>To: ${w.to}</li>
        <li>Total Mass: ${w.totalMass.toLocaleString()}</li>
        <li>Max Jump Mass: ${w.maxIndividualMass.toLocaleString()}</li>
        <li>Class: ${w.classification}</li>
        <li>Max Stable Time: ${w.maxStableTime} h</li>`;
      if (w.massRegeneration) {
        html += `<li>Regen: ${w.massRegeneration.toLocaleString()}/s</li>`;
      }
      html += '</ul>';
      whDetails.innerHTML = html;
    }

    // --- Step 4: compute one-shot plan ---
    function buildPlan() {
      const cold = parseInt(coldInput.value, 10);
      const hot  = parseInt(hotInput.value, 10);
      const diff = Math.max(0, startMass - goalMass);
      const maxInd = currentWH.maxIndividualMass;

      // Pick the pattern (out/back) that yields the largest per-ship mass while honoring maxIndividualMass
      const patterns = [
        {out: hot, back: hot},
        {out: cold, back: hot},
        {out: hot, back: cold},
        {out: cold, back: cold}
      ].filter(p => p.out <= maxInd && p.back <= maxInd);

      if (patterns.length === 0) {
        planSummary.textContent = 'Error: neither hot nor cold mass fits the hole’s max individual mass.';
        planSteps.textContent = '';
        return;
      }

      patterns.forEach(p => p.per = p.out + p.back);
      patterns.sort((a, b) => b.per - a.per);  // descending by mass moved per round-trip
      const best = patterns[0];
      const ships = Math.ceil(diff / best.per);

      // Summary
      planSummary.textContent =
        `Use ${ships} ship${ships > 1 ? 's' : ''}, each ` +
        `jumping ${best.out.toLocaleString()} kg out and ${best.back.toLocaleString()} kg back.`;

      // Detailed steps
      const lines = [
        `Total mass to move: ${diff.toLocaleString()} kg`,
        `Mass moved per ship round-trip: ${best.per.toLocaleString()} kg`,
        `→ You need ${ships} round-trip${ships>1?'s':''}`,
        ``,
        `Steps:`,
        `1) Jump all ${ships} ship${ships>1?'s':''} out at ${best.out.toLocaleString()} kg.`,
        `2) Return all ${ships} ship${ships>1?'s':''} at ${best.back.toLocaleString()} kg.`,
        `3) Hole should now be at or past your goal threshold.`
      ];
      planSteps.textContent = lines.join('\n');
    }

    // Initialize
    showStep(1);
  </script>

</body>
</html>
